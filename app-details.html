<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do App | World Inova</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header class="header-dark">
    <nav class="nav-dark" style="display:flex; align-items:center; flex-wrap:nowrap; padding-top:24px;">
    <div class="logo-dark" id="logo-bar" style="display:flex; flex-direction:row; align-items:center; gap:0px; margin-left:0px; margin-right:-40px; min-width:340px; justify-content:flex-end;">
        <img src="images/wii.png" alt="Logo World Inova" style="height:80px; margin-left:0px; padding-top:-25px; margin-right:50px;">
        <div style="display:flex; flex-direction:column; align-items:flex-start;">
            <span style="font-family:'Poppins','Inter',Arial,sans-serif; font-size:2.2rem; font-weight:700; color:#e9d460; letter-spacing:2px; margin-left:-20px; line-height:1.0;">World<br>Inova</span>
            <div style="font-size:0.80rem; color:#e9d460; font-weight:400; margin-top:12px; text-align:left; margin-left:-20px; letter-spacing:2px;">
                Seu mundo mais inteligente
            </div>
        </div>
    </div>
        <ul style="margin-left: 60px;">
    <li><a href="index.html#home">Home</a></li>
    <li><a href="index.html#portfolio">Portfólio</a></li>
    <li><a href="index.html#about">Sobre</a></li>
    <li><a href="index.html#contact">Contato</a></li>
    <li style="position:relative;">
        <a href="index.html#admin" id="admin-btn">Admin</a>
        <a href="index.html#admin" id="msg-link" style="position:relative; display:inline-flex; align-items:center; justify-content:center; width:110px; height:80px; background:#221a36; border-radius:16px; box-shadow:0 2px 8px #0002; margin-left:34px; overflow:visible;">
            <span style="font-size:2.2rem; display:flex; margin-left:100px; align-items:center; justify-content:center; margin:0;">&#128233;</span>
            <span id="msg-count" style="position:absolute; top:-8px; right:-8px; background:#ff5252; color:#fff; font-size:1.1rem; font-weight:700; min-width:24px; min-height:24px; height:24px; line-height:24px; border-radius:50%; box-shadow:0 2px 8px #0003; text-align:center; padding:0; z-index:10; display:flex; align-items:center; justify-content:center;">3</span>
        </a>
    </li>
</ul>
    </nav>
</header>

    <main>
        <h2 style="text-align:center;margin:32px 0 24px 0;font-size:1.1em;">App Instituição Religiosa</h2>
        <button id="add-app-btn" class="add-app-btn" style="display:none;">Adicionar Novo App</button>
        <div class="app-detalhes-container" id="detalhes-apps">
            <!-- Cards dos apps serão inseridos via JS -->
        </div>
    </main>

    <footer class="footer-dark">
        <p>&copy; 2025 World Inova. Todos os direitos reservados.</p>
        <p>
            <br>
            Rua General Hugo de Abreu, 594 - Boehmerwald - Joinville - CEP 89232-600 - SC
        </p>
    </footer>
    <script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbsVCpF09twr4wpCYHB_cbA1oNkCuqtj0",
        authDomain: "site-mundoteknologia.firebaseapp.com",
        projectId: "site-mundoteknologia",
        storageBucket: "site-mundoteknologia.appspot.com",
        messagingSenderId: "171461943616",
        appId: "1:171461943616:web:07cb0ada17038be0641aa5",
        measurementId: "G-EJTL4ERWMP",
        databaseURL: "https://site-mundoteknologia-default-rtdb.firebaseio.com"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const ADMINS = [
        "Frty58XjXdfYNxh0gquwjgBMEv12",
        "q8CyMhIWREMI6QrZVlUQvFeMQTC2",
        "rPn9EWLFGWRnPbxAm3BTrplK3Wh1"
    ];
    // Função para atualizar o número de mensagens recebidas
    function updateMsgCount() {
        const msgCountSpan = document.getElementById('msg-count');
        onValue(ref(db, 'mensagens'), (snapshot) => {
            const data = snapshot.val();
            let count = 0;
            if (data) {
                count = Object.keys(data).length;
            }
            msgCountSpan.textContent = count;
        });
    }
    updateMsgCount();

    // Carrega apps do banco de dados
    function loadApps(callback) {
        onValue(ref(db, 'apps'), (snapshot) => {
            const data = snapshot.val();
            let apps = [];
            if (data) {
                apps = Object.keys(data).map(id => ({
                    id,
                    ...data[id]
                }));
            }
            callback(apps);
        });
    }

    // Salva app no banco de dados
    function saveApp(app) {
        return set(ref(db, 'apps/' + app.id), app);
    }

    // Cria novo app no banco de dados
    function createApp(app, cb) {
        const newRef = push(ref(db, 'apps'));
        app.id = newRef.key;
        set(newRef, app).then(() => cb && cb(app));
    }

    // Remove app do banco de dados
    function deleteApp(appId) {
        return remove(ref(db, 'apps/' + appId));
    }

    // Salva imagem no banco de dados (base64)
    function handleImageUpload(file, cb) {
        const reader = new FileReader();
        reader.onload = function(e) {
            cb(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    function renderCards(apps, isAdmin) {
        const container = document.getElementById('detalhes-apps');
        container.innerHTML = "";
        apps.slice(0, 6).forEach((app, idx) => {
            let img = app.img || 'images/placeholder.png';
            container.innerHTML += `
            <div class="app-card${!isAdmin ? ' readonly' : ''}" data-id="${app.id}">
                <label>Nome do APP</label>
                <input type="text" value="${app.nome || ''}" ${!isAdmin ? 'readonly' : ''} />
                <label>Descrição do APP</label>
                <textarea rows="2" ${!isAdmin ? 'readonly' : ''}>${app.descricao || ''}</textarea>
                <div class="image-preview">
                    <img src="${img}" alt="App" onerror="this.src='images/placeholder.png'">
                    ${isAdmin && img !== 'images/placeholder.png' ? `<button class="remove-img-btn" title="Remover imagem">&times;</button>` : ''}
                </div>
                ${isAdmin ? `
                    <label class="img-upload-label">Adicionar/Alterar imagem</label>
                    <input type="file" accept="image/*" />
                ` : ''}
                <label>Detalhes App</label>
                <textarea rows="3" ${!isAdmin ? 'readonly' : ''}>${app.detalhes || ''}</textarea>
                ${isAdmin ? `
                    <button class="btn-dark save-btn">Salvar</button>
                    <button class="btn-dark delete-btn" style="background:#ff5252;margin-top:8px;">Excluir Card</button>
                ` : ''}
            </div>
            `;
        });

        // Eventos de edição e upload (apenas admin)
        if (isAdmin) {
            document.querySelectorAll('.app-card').forEach((card, idx) => {
                const id = card.getAttribute('data-id');
                const nomeInput = card.querySelector('input[type="text"]');
                const descTextarea = card.querySelectorAll('textarea')[0];
                const detalhesTextarea = card.querySelectorAll('textarea')[1];
                const imgTag = card.querySelector('.image-preview img');
                const fileInput = card.querySelector('input[type="file"]');
                const saveBtn = card.querySelector('.save-btn');
                const deleteBtn = card.querySelector('.delete-btn');
                const removeImgBtn = card.querySelector('.remove-img-btn');

                // Remover imagem
                if (removeImgBtn) {
                    removeImgBtn.addEventListener('click', function() {
                        imgTag.src = 'images/placeholder.png';
                    });
                }

                // Upload de imagem
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        if (fileInput.files && fileInput.files[0]) {
                            handleImageUpload(fileInput.files[0], (base64) => {
                                imgTag.src = base64;
                            });
                        }
                    });
                }

                // Salvar alterações
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        const updated = {
                            id,
                            nome: nomeInput.value,
                            descricao: descTextarea.value,
                            detalhes: detalhesTextarea.value,
                            img: imgTag.src
                        };
                        saveApp(updated).then(() => {
                            saveBtn.textContent = "Salvo!";
                            setTimeout(() => saveBtn.textContent = "Salvar", 1200);
                        });
                    });
                }

                // Excluir card/app
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        if (confirm('Tem certeza que deseja excluir este card?')) {
                            deleteApp(id);
                        }
                    });
                }
            });
        }
    }

    // --- TODOS VEEM, SÓ ADMIN EDITA/EXCLUI ---
    let isAdmin = false;
    onAuthStateChanged(auth, (user) => {
        isAdmin = !!(user && user.emailVerified && ADMINS.includes(user.uid));
        loadApps(apps => renderCards(apps, isAdmin));
        document.getElementById('add-app-btn').style.display = isAdmin ? 'block' : 'none';
    });

    document.getElementById('add-app-btn').addEventListener('click', function() {
        if (!isAdmin) return;
        loadApps(apps => {
            if (apps.length >= 6) {
                alert('Limite de 6 cards atingido.');
                return;
            }
            createApp({
                nome: "Nome do APP",
                descricao: "Descrição do APP",
                img: "",
                detalhes: "Detalhes App"
            });
        });
    });
    </script>
</body>
</html>